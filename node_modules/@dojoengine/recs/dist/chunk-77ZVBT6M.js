var P=(o=>(o[o.Boolean=0]="Boolean",o[o.Number=1]="Number",o[o.OptionalNumber=2]="OptionalNumber",o[o.BigInt=3]="BigInt",o[o.OptionalBigInt=4]="OptionalBigInt",o[o.String=5]="String",o[o.OptionalString=6]="OptionalString",o[o.NumberArray=7]="NumberArray",o[o.OptionalNumberArray=8]="OptionalNumberArray",o[o.BigIntArray=9]="BigIntArray",o[o.OptionalBigIntArray=10]="OptionalBigIntArray",o[o.StringArray=11]="StringArray",o[o.OptionalStringArray=12]="OptionalStringArray",o[o.Entity=13]="Entity",o[o.OptionalEntity=14]="OptionalEntity",o[o.EntityArray=15]="EntityArray",o[o.OptionalEntityArray=16]="OptionalEntityArray",o[o.T=17]="T",o[o.OptionalT=18]="OptionalT",o[o.Schema=19]="Schema",o))(P||{}),w=(s=>(s[s.Enter=0]="Enter",s[s.Exit=1]="Exit",s[s.Update=2]="Update",s[s.Noop=3]="Noop",s))(w||{}),O=[14,16,2,8,4,10,6,12,18];import{transformIterator as j,uuid as F}from"@latticexyz/utils";import{mapObject as N}from"@latticexyz/utils";import{filter as K,map as L,Subject as $}from"rxjs";function M(e){let t=new Map;function n(u){let l=t.get(a(u));return l?new Set([...l].map(x)):new Set}function a(u){return Object.values(u).join("/")}function s(u,l){if(!l)return;let C=a(l),f=t.get(C);f||(f=new Set,t.set(C,f)),f.add(u)}function m(u,l){if(!l)return;let C=a(l),f=t.get(C);f&&f.delete(u)}for(let u of k(e)){let l=v(e,u);s(g(u),l)}let d=e.update$.subscribe(({entity:u,value:l})=>{m(g(u),l[1]),s(g(u),l[0])});return e.world.registerDisposer(()=>d?.unsubscribe()),{...e,getEntitiesWithValue:n}}import{map as W,pipe as B}from"rxjs";function X(e,t){return e.component===t}function U(e,t){let n=v(t,e);return{entity:e,component:t,value:[n,void 0],type:n==null?3:0}}function Y(e){return B(W(t=>U(t,e)))}function T(e){return"getEntitiesWithValue"in e}function I(e,t){return Object.keys(e.schema).every(n=>n in t)}function b(e){return e.metadata?.componentName??e.metadata?.tableName??e.metadata?.tableId??e.metadata?.contractId??e.id}function se(e,t,n){if(Object.keys(t).length===0)throw new Error("Component schema must have at least one key");let a=n?.id??F(),s=N(t,()=>new Map),m=new $,d=n?.metadata,l={values:s,schema:t,id:a,update$:m,metadata:d,entities:()=>j(Object.values(s)[0].keys(),x),world:e};return n?.indexed&&(l=M(l)),e.registerComponent(l),l}function E(e,t,n,a={}){let s=g(t),m=v(e,t);for(let[d,u]of Object.entries(n))e.values[d]?e.values[d].set(s,u):e.metadata?.tableId&&/^\d+$/.test(d)||console.warn("Component definition for",b(e),"is missing key",d,", ignoring value",u,"for entity",t,". Existing keys: ",Object.keys(e.values));a.skipUpdateStream||e.update$.next({entity:t,value:[n,m],component:e})}function ue(e,t,n,a,s={}){let m=v(e,t);if(m===void 0){if(a===void 0)throw new Error(`Can't update component ${b(e)} without a current value or initial value`);E(e,t,{...a,...n},s)}else E(e,t,{...m,...n},s)}function le(e,t,n={}){let a=g(t),s=v(e,t);for(let m of Object.keys(e.values))e.values[m].delete(a);n.skipUpdateStream||e.update$.next({entity:t,value:[void 0,s],component:e})}function de(e,t){let n=g(t);return Object.values(e.values)[0].has(n)}function v(e,t){function n(d,u,l){let C={},f=Object.keys(d);for(let S of f){let p=l[S];if(typeof p=="object"){let i=n(d[S],u,p);if(i===void 0)return;C[S]=i}else{if(p===void 0&&!O.includes(d[S]))return;C[S]=p}}return C}let a={},s=g(t),m=Object.keys(e.schema);for(let d of m){let u=e.values[d].get(s);if(typeof u=="object"){let l=n(e.schema[d],s,u);if(l===void 0)return;a[d]=l}else{if(u===void 0&&!O.includes(e.schema[d]))return;a[d]=u}}return a}function me(e,t){let n=v(e,t);if(!n)throw new Error(`No value for component ${b(e)} on entity ${t}`);return n}function R(e,t){if(!e&&!t)return!0;if(!e||!t)return!1;let n=!0;for(let a of Object.keys(e))if(n=e[a]===t[a],!n)return!1;return n}function ce(e,t){return[e,t]}function Se(e,t){if(T(e)&&I(e,t))return e.getEntitiesWithValue(t);let n=new Set;for(let a of k(e)){let s=v(e,a);R(t,s)&&n.add(a)}return n}function k(e){return e.entities()}function fe(e){let t=0,n=new Map,a=new Map,s=new $;function m(i,r){n.set(i,{update:r,nonce:t++}),p(r.entity,r.value)}function d(i){let r=n.get(i)?.update.entity;if(n.delete(i),r==null)return;let y=[...n.values()].filter(c=>c.update.entity===r).sort((c,h)=>c.nonce<h.nonce?-1:1);if(y.length>0){let c=y[y.length-1];p(r,c.update.value)}else p(r,void 0)}function u(i){let r=v(e,i),y=g(i),c=a.get(y);return(r||c)&&c!==null?{...r,...c}:void 0}let l=i=>({get(r,y){return y==="get"?c=>{let h=r.get(c),V=a.get(c);return V&&V[i]!=null?V[i]:h}:y==="has"?c=>r.has(c)||a.has(c):y==="keys"?()=>new Set([...r.keys(),...a.keys()]).values():Reflect.get(r,y,r)}}),C={};for(let i of Object.keys(e.values))C[i]=new Proxy(e.values[i],l(i));let f=C,S=new Proxy(e,{get(i,r){return r==="addOverride"?m:r==="removeOverride"?d:r==="values"?f:r==="update$"?s:r==="entities"?()=>new Set([...j(a.keys(),x),...i.entities()]).values():Reflect.get(i,r)},has(i,r){return r==="addOverride"||r==="removeOverride"?!0:r in i}});function p(i,r){let y=g(i),c=u(i);r!==void 0?a.set(y,r):a.delete(y),s.next({entity:i,value:[u(i),c],component:S})}return e.update$.pipe(K(i=>!a.get(g(i.entity))),L(i=>({...i,component:S}))).subscribe(s),S}function A(e,t){return`localcache-${t}-${e.id}`}function pe(e,t){localStorage.removeItem(A(e,t))}function ye(e,t){let{world:n,update$:a,values:s}=e,m=A(e,t),d=0,u=Date.now(),l=localStorage.getItem(m);if(l){let f=JSON.parse(l),S={};for(let[p,i]of f)for(let[r,y]of i)S[r]=S[r]||{},S[r][p]=y;for(let[p,i]of Object.entries(S)){let r=n.registerEntity({id:p});E(e,r,i)}console.info("Loading component",b(e),"from local cache.")}let C=a.subscribe(()=>{d++;let f=JSON.stringify(Object.entries(N(s,S=>[...S.entries()].map(p=>[x(p[0]),p[1]]))));localStorage.setItem(m,f),d>200&&console.warn("Component",b(e),"was locally cached",d,"times since",new Date(u).toLocaleTimeString(),"- the local cache is in an alpha state and should not be used with components that update frequently yet")});return e.world.registerDisposer(()=>C?.unsubscribe()),e}function ve(e,t,n){let a=e.registerEntity(n??{});if(t)for(let[s,m]of t)E(s,a,m);return a}function g(e){return Symbol.for(e)}function x(e){return Symbol.keyFor(e)}export{P as a,w as b,O as c,ve as d,g as e,x as f,M as g,X as h,U as i,Y as j,T as k,I as l,se as m,E as n,ue as o,le as p,de as q,v as r,me as s,R as t,ce as u,Se as v,k as w,fe as x,pe as y,ye as z};
//# sourceMappingURL=chunk-77ZVBT6M.js.map